---
title: "[YML or YAML] æ‹¡å¼µå­ã®é•ã„ã§ã€ prometheus ã®è¨­å®šãŒåæ˜ ã•ã‚Œãªã„ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹"
emoji: "ğŸ…°ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["prometheus", "yaml", "yml"]
published: false
---

åˆæ­©çš„ãªãƒŸã‚¹ã®å‚™å¿˜éŒ²ã§ã™ğŸ˜‡

# ä¸€æ–‡ã¾ã¨ã‚
prometheus ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«(`/etc/prometheus/prometheus.yml`)ã‚’ä¸Šæ›¸ãã—ãŸã¤ã‚‚ã‚ŠãŒã€ åæ˜ ã•ã‚Œã‚‹ã“ã¨ã®ãªã„ `/etc/prometheus/prometheus.yaml` ã‚’æ–°è¦ç”Ÿæˆã—ã¦ã—ã¾ã£ã¦ã„ãŸğŸ˜‡

## è§£æ±ºç­–
è§£æ±ºç­–ã¨ã—ã¦ã€`prometheus.yml` ã‚’ä½¿ã†ã‹ã€`prometheus.yaml` ã§ã‚ã£ã¦ã‚‚ä¸Šæ›¸ãã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ã‹ã€ã®äºŒé€šã‚Šã‚ã‚‹ãŒã€

> Go ã«å…¥ã£ã¦ã¯ Go ã«å¾“ãˆ

https://gihyo.jp/news/report/01/GoCon2014Autumn/0002

ã¨ã‚ˆãè¨€ã‚ã‚Œã‚‹ã®ã§å‰è€…ã®å¯¾å¿œãŒé©åˆ‡ã«æ€ã†ã€‚

# è£œè¶³
è£œè¶³ã¨ã—ã¦ã€YAML ã®æ‹¡å¼µå­ã«ã¯ã€ `yaml` ã‹ `yml` ãŒç”¨ã„ã‚‰ã‚Œã‚‹[^1]ã€‚

ãã—ã¦ã€[prometheus/prometheus](https://github.com/prometheus/prometheus/tree/release-2.42/config/testdata)ã«ãŠã„ã¦ã¯ã€ `yaml` ã§ã¯ãªã `yml` ãŒä¸»æµã§ã‚ã‚‹[^p]ã€‚

ã¾ãŸã€ prometheus ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ä»¥ä¸‹ã®é€šã‚Š `prometheus.yml` ãŒè¨­ç½®ã•ã‚Œã€èª­ã¿è¾¼ã¾ã‚Œã‚‹ã€‚ã‚ˆã£ã¦ã€`prometheus.yaml` ã‚’æ¸¡ã™ã ã‘ã§ã¯ `prometheus.yml` ãŒå„ªå…ˆã•ã‚Œã¦ã—ã¾ã„ã€æœ›ã‚“ã è¨­å®šãŒåæ˜ ã•ã‚Œãªã„ã€‚

https://github.com/prometheus/prometheus/blob/35026fb26d30fb63dbe6557058fb336c1bd400fa/Dockerfile#L10

https://github.com/prometheus/prometheus/blob/35026fb26d30fb63dbe6557058fb336c1bd400fa/Dockerfile#L25

ã¾ãŸç­†è€…ã¯æ™®æ®µ `yaml` ã‚’ä½¿ã£ã¦ã„ã‚‹ ğŸ˜‡

# å†ç¾æ‰‹é †
ä»¥ä¸‹ã§ã¯ã€æœ¬ä»¶ã®å†ç¾æ‰‹é †ã«ã¤ã„ã¦è¿°ã¹ã‚‹ã€‚
ã‚½ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã€‚

https://github.com/rokkish/prometheus_dot_yml_has_priority_over_dot_yaml

## prometheus ã®è¨­å®š
è¨­å®šãŒåæ˜ ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã€ prometheus ã«ä»»æ„ã®è¨­å®šã‚’è¨˜è¿°ã—ã¦ãŠãã€‚
```yaml:prometheus.yaml
scrape_configs:
  - job_name: 'node_exporter'
    static_configs:
      - targets: ['node_exporter:9100']
```

## è¨­å®šãŒåæ˜ ã•ã‚Œãªã„ã‚±ãƒ¼ã‚¹
å¿…è¦æœ€ä½é™ã®prometheusã€node_exporterã€grafanaã®è¨­å®šã‚’è¨˜è¿°ã—ã¦ãŠãã€‚
```yaml:compose.yaml
services:
  prometheus:
    image: prom/prometheus
    volumes:
      - ./prometheus.yaml:/etc/prometheus/prometheus.yaml # åæ˜ ã•ã‚Œãªã„ ğŸ˜‡ğŸ˜‡ğŸ˜‡ğŸ˜‡
    ports:
      - 9090:9090
    container_name: prometheus
  node_exporter:
    image: prom/node-exporter
    container_name: node_exporter
  grafana:
    image: grafana/grafana-oss:9.3.6
    ports:
      - 3000:3000
    volumes:
      - grafana_data:/var/lib/grafana
volumes:
  grafana_data:
```
ä¸Šè¨˜ã®è¨­å®šã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç«‹ã¡ä¸Šã’ã‚‹ã¨ã€ä»¥ä¸‹ã®é€šã‚Š `prometheus.yaml` ã¨ `prometheus.yml` ãŒå…±å­˜ã™ã‚‹[^scrape]ã€‚
```sh
$ git clone -b fail_case git@github.com:rokkish/prometheus_dot_yml_has_priority_over_dot_yaml.git
$ cd prometheus_dot_yml_has_priority_over_dot_yaml  
$ docker compose up -d
[+] Running 3/0
 â ¿ Container prometheus_dot_yml_has_priority_over_dot_yaml_grafana_1  Running             0.0s
 â ¿ Container node_exporter                                            Running             0.0s
 â ¿ Container prometheus                                               Running             0.0s
$ docker exec -it prometheus sh
/prometheus $ ls -al /etc/prometheus/prometheus.*
-rw-r--r-- 1 1000   1001   106 Feb 24 10:11 prometheus.yaml // åæ˜ ã•ã‚Œãªã„ ğŸ˜‡ğŸ˜‡ğŸ˜‡ğŸ˜‡
-rw-r--r-- 1 nobody nobody 934 Feb  1 08:23 prometheus.yml  // ã“ã¡ã‚‰ãŒåæ˜ ã•ã‚Œã¦ã—ã¾ã† ğŸ˜‡ğŸ˜‡ğŸ˜‡ğŸ˜‡
$ docker compose stop
$ docker rm prometheus
```

## è¨­å®šãŒåæ˜ ã•ã‚Œã‚‹ã‚±ãƒ¼ã‚¹
æ—¢å­˜ã® `prometheus.yml` ã‚’ä¸Šæ›¸ãå¯¾è±¡ã¨ã™ã‚‹ã¨ã€
```diff:compose.yaml
-      - ./prometheus.yaml:/etc/prometheus/prometheus.yaml // åæ˜ ã•ã‚Œãªã„ ğŸ˜‡ğŸ˜‡ğŸ˜‡ğŸ˜‡
+      - ./prometheus.yaml:/etc/prometheus/prometheus.yml // åæ˜ ã•ã‚Œã‚‹ ğŸ¥°ğŸ¥°ğŸ¥°ğŸ¥°
# or
+      - ./prometheus.yml:/etc/prometheus/prometheus.yml // åæ˜ ã•ã‚Œã‚‹ ğŸ¥°ğŸ¥°ğŸ¥°ğŸ¥°
```

ä»¥ä¸‹ã®é€šã‚Šã€æ­£ã—ãä¸Šæ›¸ãã•ã‚Œã‚‹ã€‚

```sh:pass_case
# $ git checkout -b pass_case
$ docker compose up -d
$ docker exec -it prometheus sh
/prometheus $ ls -al /etc/prometheus/prometheus.*
-rw-r--r-- 1 1000 1001 106 Feb 24 10:11 prometheus.yml // åæ˜ ã•ã‚Œã‚‹ ğŸ¥°ğŸ¥°ğŸ¥°ğŸ¥°
```

# ãŠã‚ã‚Šã«
- 3æ–‡å­—æ‹¡å¼µå­ã¨4æ–‡å­—æ‹¡å¼µå­ã®é•ã„ã§ã€æŒ™å‹•ãŒç•°ãªã‚‹ã‚±ãƒ¼ã‚¹ã¯åˆã‚ã¦é­é‡ã—ãŸã®ã§ã€è¨˜å¿µã«è¨˜äº‹ã«ã—ã¦ã¿ã¾ã—ãŸã€‚
  - ã€Œå¤‰æ›´ã—ãŸã¯ãšã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒåæ˜ ã•ã‚Œãªã„ï¼ï¼Ÿ â†’ å‹˜é•ã„ã ã£ãŸã€ã¨ã„ã†ã‚±ãƒ¼ã‚¹ã¯ã“ã‚Œã¾ã§ä½•åº¦ã‚‚çµŒé¨“ãŒã‚ã‚Šã¾ã™ã­...
- æœ¬ä»¶ã¯ã–ã£ã¨è¦‹ãŸã¨ã“ã‚ã€ Issue ã‚„ PR ã«ã¯ä¸ŠãŒã£ã¦ã¯ãªã•ãã†ãªã®ã§ã€ä»Šå¾Œå ±å‘Šäºˆå®šã§ã™ğŸ« 

[^1]: Officialã§ã¯yamlã‚’æ¨å¥¨ï¼šhttps://yaml.org/faq.html 
[^p]: testdataãŒã™ã¹ã¦ymlã ...ï¼šhttps://github.com/prometheus/prometheus/tree/release-2.42/config/testdata
[^scrape]: prometheus ãŒ node_exporter ã‚’ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å‡ºæ¥ãªã„ã“ã¨ã‹ã‚‰ã€`prometheus.yml` ãŒé©ç”¨ã•ã‚Œã‚‹ã“ã¨ãŒç¢ºèªã§ããŸã€‚
